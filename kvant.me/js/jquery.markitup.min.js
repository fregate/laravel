(function($){$.fn.markItUp=function(m,o){var p,params,options,ctrlKey,shiftKey,altKey;ctrlKey=shiftKey=altKey=false;if(typeof m=='string'){p=m;params=o}options={id:'',nameSpace:'',root:'',previewHandler:false,previewInWindow:'',previewInElement:'',previewAutoRefresh:true,previewPosition:'after',previewTemplatePath:'~/templates/preview.html',previewParser:false,previewParserPath:'',previewParserVar:'data',resizeHandle:true,beforeInsert:'',afterInsert:'',onEnter:{},onShiftEnter:{},onCtrlEnter:{},onTab:{},markupSet:[{}]};$.extend(options,m,o);if(!options.root){$('script').each(function(a,b){miuScript=$(b).get(0).src.match(/(.*)jquery\.markitup(\.pack)?\.js$/);if(miuScript!==null){options.root=miuScript[1]}})}var q=function(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}};var r=q(navigator.userAgent);var s={};if(r.browser){s[r.browser]=true;s.version=r.version}if(s.chrome){s.webkit=true}else if(s.webkit){s.safari=true}return this.each(function(){var k,textarea,levels,scrollPosition,caretPosition,caretOffset,clicked,hash,header,footer,previewWindow,template,iFrame,abort;k=$(this);textarea=this;levels=[];abort=false;scrollPosition=caretPosition=0;caretOffset=-1;options.previewParserPath=localize(options.previewParserPath);options.previewTemplatePath=localize(options.previewTemplatePath);if(p){switch(p){case'remove':remove();break;case'insert':markup(params);break;default:$.error('Method '+p+' does not exist on jQuery.markItUp')}return}function localize(a,b){if(b){return a.replace(/("|')~\//g,"$1"+options.root)}return a.replace(/^~\//,options.root)}function init(){id='';nameSpace='';if(options.id){id='id="'+options.id+'"'}else if(k.attr("id")){id='id="markItUp'+(k.attr("id").substr(0,1).toUpperCase())+(k.attr("id").substr(1))+'"'}if(options.nameSpace){nameSpace='class="'+options.nameSpace+'"'}k.wrap('<div '+id+' class="markItUp"></div>');k.wrap('<div class="markItUpContainer"></div>');k.addClass("markItUpEditor");header=$('<div class="markItUpHeader"></div>').insertBefore(k);$(dropMenus(options.markupSet)).appendTo(header);footer=$('<div class="markItUpFooter"></div>').insertAfter(k);if(options.resizeHandle===true&&s.safari!==true){resizeHandle=$('<div class="markItUpResizeHandle"></div>').insertAfter(k).bind("mousedown.markItUp",function(e){var h=k.height(),y=e.clientY,mouseMove,mouseUp;mouseMove=function(e){k.css("height",Math.max(20,e.clientY+h-y)+"px");return false};mouseUp=function(e){$("html").unbind("mousemove.markItUp",mouseMove).unbind("mouseup.markItUp",mouseUp);return false};$("html").bind("mousemove.markItUp",mouseMove).bind("mouseup.markItUp",mouseUp)});footer.append(resizeHandle)}k.bind('keydown.markItUp',keyPressed).bind('keyup',keyPressed);k.bind("insertion.markItUp",function(e,a){if(a.target!==false){get()}if(textarea===$.markItUp.focused){markup(a)}});k.bind('focus.markItUp',function(){$.markItUp.focused=this});if(options.previewInElement){refreshPreview()}}function dropMenus(b){var c=$('<ul></ul>'),i=0;$('li:hover > ul',c).css('display','block');$.each(b,function(){var a=this,t='',title,li,j;title=(a.key)?(a.name||'')+' [Ctrl+'+a.key+']':(a.name||'');key=(a.key)?'accesskey="'+a.key+'"':'';if(a.separator){li=$('<li class="markItUpSeparator">'+(a.separator||'')+'</li>').appendTo(c)}else{li=$('<li class="markItUpButton markItUpButton'+a.className+'"><a href="" '+key+' title="'+title+'">'+a.name+'</a></li>').bind("contextmenu.markItUp",function(){return false}).bind('click.markItUp',function(e){e.preventDefault()}).bind("focusin.markItUp",function(){k.focus()}).bind('mouseup',function(){if(a.call){eval(a.call)()}setTimeout(function(){markup(a)},1);return false}).bind('mouseenter.markItUp',function(){$('> ul',this).show();$(document).one('click',function(){$('ul ul',header).hide()})}).bind('mouseleave.markItUp',function(){$('> ul',this).hide()}).appendTo(c);if(a.dropMenu){levels.push(i);$(li).addClass('markItUpDropMenu').append(dropMenus(a.dropMenu))}}});return c}function magicMarkups(c){if(c){c=c.toString();c=c.replace(/\(\!\(([\s\S]*?)\)\!\)/g,function(x,a){var b=a.split('|!|');if(altKey===true){return(b[1]!==undefined)?b[1]:b[0]}else{return(b[1]===undefined)?"":b[0]}});c=c.replace(/\[\!\[([\s\S]*?)\]\!\]/g,function(x,a){var b=a.split(':!:');if(abort===true){return false}value=prompt(b[0],(b[1])?b[1]:'');if(value===null){abort=true}return value});return c}return""}function prepare(a){if($.isFunction(a)){a=a(hash)}return magicMarkups(a)}function build(a){var b=prepare(clicked.openWith);var c=prepare(clicked.placeHolder);var d=prepare(clicked.replaceWith);var e=prepare(clicked.closeWith);var f=prepare(clicked.openBlockWith);var g=prepare(clicked.closeBlockWith);var h=clicked.multiline;if(d!==""){block=b+d+e}else if(selection===''&&c!==''){block=b+c+e}else{a=a||selection;var i=[a],blocks=[];if(h===true){i=a.split(/\r?\n/)}for(var l=0;l<i.length;l++){line=i[l];var j;if(j=line.match(/ *$/)){blocks.push(b+line.replace(/ *$/g,'')+e+j)}else{blocks.push(b+line+e)}}block=blocks.join("\n")}block=f+block+g;return{block:block,openBlockWith:f,openWith:b,replaceWith:d,placeHolder:c,closeWith:e,closeBlockWith:g}}function markup(a){var b,j,n,i;hash=clicked=a;get();$.extend(hash,{line:"",root:options.root,textarea:textarea,selection:(selection||''),caretPosition:caretPosition,ctrlKey:ctrlKey,shiftKey:shiftKey,altKey:altKey});prepare(options.beforeInsert);prepare(clicked.beforeInsert);if((ctrlKey===true&&shiftKey===true)||a.multiline===true){prepare(clicked.beforeMultiInsert)}$.extend(hash,{line:1});if((ctrlKey===true&&shiftKey===true)){lines=selection.split(/\r?\n/);for(j=0,n=lines.length,i=0;i<n;i++){if($.trim(lines[i])!==''){$.extend(hash,{line:++j,selection:lines[i]});lines[i]=build(lines[i]).block}else{lines[i]=""}}string={block:lines.join('\n')};start=caretPosition;b=string.block.length+((s.opera)?n-1:0)}else if(ctrlKey===true){string=build(selection);start=caretPosition+string.openWith.length;b=string.block.length-string.openWith.length-string.closeWith.length;b=b-(string.block.match(/ $/)?1:0);b-=fixIeBug(string.block)}else if(shiftKey===true){string=build(selection);start=caretPosition;b=string.block.length;b-=fixIeBug(string.block)}else{string=build(selection);start=caretPosition+string.block.length;b=0;start-=fixIeBug(string.block)}if((selection===''&&string.replaceWith==='')){caretOffset+=fixOperaBug(string.block);start=caretPosition+string.openBlockWith.length+string.openWith.length;b=string.block.length-string.openBlockWith.length-string.openWith.length-string.closeWith.length-string.closeBlockWith.length;caretOffset=k.val().substring(caretPosition,k.val().length).length;caretOffset-=fixOperaBug(k.val().substring(0,caretPosition))}$.extend(hash,{caretPosition:caretPosition,scrollPosition:scrollPosition});if(string.block!==selection&&abort===false){insert(string.block);set(start,b)}else{caretOffset=-1}get();$.extend(hash,{line:'',selection:selection});if((ctrlKey===true&&shiftKey===true)||a.multiline===true){prepare(clicked.afterMultiInsert)}prepare(clicked.afterInsert);prepare(options.afterInsert);if(previewWindow&&options.previewAutoRefresh){refreshPreview()}shiftKey=altKey=ctrlKey=abort=false}function fixOperaBug(a){if(s.opera){return a.length-a.replace(/\n*/g,'').length}return 0}function fixIeBug(a){if(s.msie){return a.length-a.replace(/\r*/g,'').length}return 0}function insert(a){if(document.selection){var b=document.selection.createRange();b.text=a}else{textarea.value=textarea.value.substring(0,caretPosition)+a+textarea.value.substring(caretPosition+selection.length,textarea.value.length)}}function set(a,b){if(textarea.createTextRange){if(s.opera&&s.version>=9.5&&b==0){return false}range=textarea.createTextRange();range.collapse(true);range.moveStart('character',a);range.moveEnd('character',b);range.select()}else if(textarea.setSelectionRange){textarea.setSelectionRange(a,a+b)}textarea.scrollTop=scrollPosition;textarea.focus()}function get(){textarea.focus();scrollPosition=textarea.scrollTop;if(document.selection){selection=document.selection.createRange().text;if(s.msie){var a=document.selection.createRange(),rangeCopy=a.duplicate();rangeCopy.moveToElementText(textarea);caretPosition=-1;while(rangeCopy.inRange(a)){rangeCopy.moveStart('character');caretPosition++}}else{caretPosition=textarea.selectionStart}}else{caretPosition=textarea.selectionStart;selection=textarea.value.substring(caretPosition,textarea.selectionEnd)}return selection}function preview(){if(typeof options.previewHandler==='function'){previewWindow=true}else if(options.previewInElement){previewWindow=$(options.previewInElement)}else if(!previewWindow||previewWindow.closed){if(options.previewInWindow){previewWindow=window.open('','preview',options.previewInWindow);$(window).unload(function(){previewWindow.close()})}else{iFrame=$('<iframe class="markItUpPreviewFrame"></iframe>');if(options.previewPosition=='after'){iFrame.insertAfter(footer)}else{iFrame.insertBefore(header)}previewWindow=iFrame[iFrame.length-1].contentWindow||frame[iFrame.length-1]}}else if(altKey===true){if(iFrame){iFrame.remove()}else{previewWindow.close()}previewWindow=iFrame=false}if(!options.previewAutoRefresh){refreshPreview()}if(options.previewInWindow){previewWindow.focus()}}function refreshPreview(){renderPreview()}function renderPreview(){var b;if(options.previewHandler&&typeof options.previewHandler==='function'){options.previewHandler(k.val())}else if(options.previewParser&&typeof options.previewParser==='function'){var c=options.previewParser(k.val());writeInPreview(localize(c,1))}else if(options.previewParserPath!==''){$.ajax({type:'POST',dataType:'text',global:false,url:options.previewParserPath,data:options.previewParserVar+'='+encodeURIComponent(k.val()),success:function(a){writeInPreview(localize(a,1))}})}else{if(!template){$.ajax({url:options.previewTemplatePath,dataType:'text',global:false,success:function(a){writeInPreview(localize(a,1).replace(/<!-- content -->/g,k.val()))}})}}return false}function writeInPreview(a){if(options.previewInElement){$(options.previewInElement).html(a)}else if(previewWindow&&previewWindow.document){try{sp=previewWindow.document.documentElement.scrollTop}catch(e){sp=0}previewWindow.document.open();previewWindow.document.write(a);previewWindow.document.close();previewWindow.document.documentElement.scrollTop=sp}}function keyPressed(e){shiftKey=e.shiftKey;altKey=e.altKey;ctrlKey=(!(e.altKey&&e.ctrlKey))?(e.ctrlKey||e.metaKey):false;if(e.type==='keydown'){if(ctrlKey===true){li=$('a[accesskey="'+((e.keyCode==13)?'\\n':String.fromCharCode(e.keyCode))+'"]',header).parent('li');if(li.length!==0){ctrlKey=false;setTimeout(function(){li.triggerHandler('mouseup')},1);return false}}if(e.keyCode===13||e.keyCode===10){if(ctrlKey===true){ctrlKey=false;markup(options.onCtrlEnter);return options.onCtrlEnter.keepDefault}else if(shiftKey===true){shiftKey=false;markup(options.onShiftEnter);return options.onShiftEnter.keepDefault}else{markup(options.onEnter);return options.onEnter.keepDefault}}if(e.keyCode===9){if(shiftKey==true||ctrlKey==true||altKey==true){return false}if(caretOffset!==-1){get();caretOffset=k.val().length-caretOffset;set(caretOffset,0);caretOffset=-1;return false}else{markup(options.onTab);return options.onTab.keepDefault}}}}function remove(){k.unbind(".markItUp").removeClass('markItUpEditor');k.parent('div').parent('div.markItUp').parent('div').replaceWith(k);k.data('markItUp',null)}init()})};$.fn.markItUpRemove=function(){return this.each(function(){$(this).markItUp('remove')})};$.markItUp=function(a){var b={target:false};$.extend(b,a);if(b.target){return $(b.target).each(function(){$(this).focus();$(this).trigger('insertion',[b])})}else{$('textarea').trigger('insertion',[b])}}})(jQuery);